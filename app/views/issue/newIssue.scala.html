@(title:String, issueForm:Form[Issue], project:Project)

@import helper._
@import scala.collection.mutable.Map
@implicitFieldConstructor = @{ FieldConstructor(twitterBootstrapInput.render) }
@import controllers.UserApp;
@import models.enumeration.ResourceType
@import models.enumeration.Operation
@import utils.AccessControl._

@main(Messages(title), project, utils.MenuType.ISSUE) {
<div class="page">
  @prjmenu(project, utils.MenuType.ISSUE, "main-menu-only")
  
  <div class="content-wrap frm-wrap">
    
    @form(action = routes.IssueApp.newIssue(project.owner, project.name), 'id -> "issue-form", 'enctype -> "multipart/form-data") {
    
    <dl>
    	<dt>
	      <div id="warning" class="n-alert hide">
	        <div class="n-inner">
	          <span class="msg">제목과 본문에 빈칸이 있습니다.</span>
	          <a href="#" class="ico btn-delete"></a>
	        </div>
	      </div>
	      <label for="title">@Messages("post.new.title")</label>
    	</dt>
    	<dd>
    		<input type="text" id="title" name="title" value="" class="text title" maxlength="250" tabindex="1">
    		@**helper.inputText(issueForm("title"), 'class->"text title", 'maxlength -> "250", 'tabindex -> 1, '_showConstraints -> false)**@
    	</dd>
    </dl>
    @** 'onkeypress -> "return event.keyCode !== 13" **@

	<textarea id="body" name="body" markdown="true" class="text content" tabindex="2"></textarea>
	@** helper.textarea(issueForm("body"), 'markdown -> true, 'class->"text content", 'tabindex -> 2, '_showConstraints -> false) **@

	<div class="content-footer">
		@** fileUploader **@
	    @if(UserApp.currentUser() != UserApp.anonymous) {
	    
		<div class="attach-wrap">
			<div class="avatar-wrap">
				<img src="@User.findByLoginId(session.get("loginId")).avatarUrl" class="img-rounded" width="32" height="32" alt="avatar">
			</div>
			
			<div id="upload" class="attach-info-wrap" resourceType="@ResourceType.ISSUE_POST">
				<div>
					<span class="progress-num">0%</span> <span class="sp-line">&nbsp;</span>
					<strong>total</strong> <span class="total-num">0MB</span>
				</div>
				<div class="progress-wrap">
					<div class="progress n4">
						<div class="bar orange" style="width: 0%;"></div>
					</div>
				</div>
				<!-- <a href="#!/cancel"><i class="ico btn-cancel"></i></a> -->
			</div>
		
			<div class="btn-wrap">
				<div class="ns-btn fake-file-wrap">
					<i class="ico ico-plus-blue"></i>@Messages("button.upload") <input type="file" class="file" name="filePath">
				</div>
			</div>
		</div>
		<script type="text/template" id="tplAttachedFile"><!--
			--><li class="attached-file" data-name="${fileName}" data-href="${fileHref}" data-mime="${mimeType}" data-size="${fileSize}">
			<strong>${fileName}(${fileSizeReadable})</strong><!--
			--><a class="attached-delete"><i class="ico btn-delete"></i></a><!--
			--></li>
		</script>
	
		<div class="attached-files-wrap">
			<ul class="attached-files"></ul>
		</div>
	}
	@** end of fileUploader **@
    </div>

	<br>
	<!-- issue.label js module appends a label selector here. -->
	<fieldset class="labels">
		@** 
		@if(isCreatable(UserApp.currentUser(), project, ResourceType.ISSUE_ASSIGNEE)) {
			@select(
				issueForm("assignee.user.id"),
				options(ProjectUser.options(project.id)),
				'_label-> Messages("issue.new.detailInfo.assignee"),
				'_default -> Messages("issue.new.selectDefault.assignee"),
				'_showConstraints -> false)
		}
		**@

		@**
		@if(isCreatable(UserApp.currentUser(), project, ResourceType.ISSUE_MILESTONE)) {
			@select(
				issueForm("milestoneId"),
				options(Milestone.options(project.id)),
				'_label-> Messages("issue.new.detailInfo.milestone"),
				'_default -> Messages("issue.new.selectDefault.milestone"),
				'_showConstraints -> false)
		}
		**@
	</fieldset>

	<!-- issue options -->
	<ul class="options unstyled issue-options">
		@if(isCreatable(UserApp.currentUser(), project, ResourceType.ISSUE_ASSIGNEE)) {
		<li class="option">
             <div class="option-label">@Messages("issue.new.detailInfo.assignee")</div>
             <div class="option-desc">
				<div id="assignee" class="btn-group" data-name="assignee.user.id">
					<button data-toggle="dropdown" class="btn dropdown-toggle d-label bgwhite">@Messages("issue.new.selectDefault.assignee")</button>
					<button data-toggle="dropdown" class="btn dropdown-toggle bgwhite"><span class="caret"></span></button>
					<ul class="dropdown-menu">
						@ProjectUser.options(project.id).map{ v =>
						<li data-value="@v._1"><a href="javascript:void(0)">@v._2</a></li>
						}
					</ul>
				</div>
             </div>
		</li>
		}
		
		@if(isCreatable(UserApp.currentUser(), project, ResourceType.ISSUE_MILESTONE)) {
		<li class="option">
             <div class="option-label">@Messages("issue.new.detailInfo.milestone")</div>
             <div class="option-desc">
				<div id="milestoneId" class="btn-group" data-name="milestoneId">
					<button data-toggle="dropdown" class="btn dropdown-toggle d-label bgwhite">@Messages("issue.new.selectDefault.milestone")</button>
					<button data-toggle="dropdown" class="btn dropdown-toggle bgwhite"><span class="caret"></span></button>
					<ul class="dropdown-menu">
						@Milestone.options(project.id).map{ v =>
						<li data-value="@v._1"><a href="javascript:void(0)">@v._2</a></li>
						}
					</ul>
				</div>
             </div>
		</li>
		}
	</ul>  
	
	<div class="actions">
      <button type="submit" class="btn-transparent n-btn orange med">@Messages("button.save")</button><!-- 
   --><a href="javascript:history.back(); return false;" class="n-btn gray med cancel">@Messages("button.cancel")</a>
   <!-- 
      <a href="@routes.IssueApp.issues(project.owner, project.name, "all")" class="n-btn gray med">@Messages("button.cancel")</a>
   -->
  </div>

  } @** end of form **@
  </div>

@markdown()

</div>

<script type="text/javascript">
	$(document).ready(function(){
		var htOptLabel = {
			"bEditable"    : true,
			"sURLLabels"   : "@routes.IssueLabelApp.labels(project.owner, project.name)", 
			"sURLPost"     : "@routes.IssueLabelApp.newLabel(project.owner, project.name)"
		};				
	
		$hive.loadModule("issue.Write", {
			"sMode"			 : "new",
			"elTextarea"	 : $("#body"),
			"sUploaderAction": "@routes.AttachmentApp.newFile",
			"htOptLabel"     : htOptLabel
		});
	});
</script>
}
