@(title: String, currentPage: com.avaje.ebean.Page[Issue], param:IssueApp.SearchCondition, project:Project)

@import helper._
@implicitFieldConstructor = @{ FieldConstructor(twitterBootstrapInput.render) } 
@import utils.TemplateHelper._
@import scala.collection.immutable.Map
@import models.enumeration._


@urlToList = {@routes.IssueApp.issues(project.owner, project.name, param.state, "html", currentPage.getPageIndex + 1)}

@**
@ordering(label:String, sortBy:String) = {
  @if(sortBy == param.sortBy) {
    @if(param.orderBy == "desc") {
      <a selected href="@urlToList&sortBy=@sortBy&orderBy=asc">▼@label</a>
    } else {
      <a selected href="@urlToList&sortBy=@sortBy&orderBy=desc">▲@label</a>
    }
  } else {
    <a href="@urlToList&sortBy=@sortBy">@label</a>
  }
}

@header(label:String, sortBy:String) = {
    <th>
        @if(sortBy == param.sortBy){
            @(param.state = "")
            @if(param.orderBy == "desc"){
                <a class="th-sort" href="@routes.IssueApp.issues(project.owner, project.name, param.state)&sortBy=@sortBy&orderBy=asc" data-sort-by="@sortBy">@label</a>
                <i class="icon-chevron-down"></i>
            } else {
                <a class="th-sort" href="@routes.IssueApp.issues(project.owner, project.name, param.state)&sortBy=@sortBy&orderBY=desc" data-sort-by="@sortBy">@label</a>
                <i class="icon-chevron-up"></i>
            }
        } else {
            <a class="th-sort" href="@routes.IssueApp.issues(project.owner, project.name, param.state)&sortBy=@sortBy" data-sort-by="@sortBy">@label</a>
        }
    </th>
}
**@

@main(Messages(title), project, utils.MenuType.ISSUE){
<div class="page">
	@prjmenu(project, utils.MenuType.ISSUE, "main-menu-only")
	
	<div class="header-wrap">
		<div class="stats-wrap">
			@for(state <- Array(State.ALL, State.OPEN, State.CLOSED)) {
			<div class="stat stat-issue @if(param.state == state.state) { active }">
				<a href="@routes.IssueApp.issues(project.owner, project.name, state.state)">
				<span class="desc @state.state"><strong>@Messages("issue.state." + state.name.toLowerCase())</strong> @Messages("issue.state.unit")</span><!-- 
				 --><span class="num @state.state">@Issue.countIssues(project.id, state)</span>
				</a>
			</div>
			}
		</div>
		<div class="search-wrap projects">
			<div class="inner">
				<form action="@routes.IssueApp.issues(project.owner, project.name, param.state)" method="get">
					<input type="hidden" name="orderBy" value="@param.orderBy" class="h-value order">
					<input type="hidden" name="state"   value="@param.state">
					<input type="text"   name="filter"  class="text" placeholder="현재 프로젝트에서 검색"><!-- 
					 --><button type="submit" class="btn search-btn">@Messages("issue.search")</button>
	                <a href="#advanced-search-form" class="btn-advanced"><i class="ico"></i>@Messages("issue.advancedSearch")</a>
                </form>
                
				<div id="advanced-search-form" class="srch-advanced form-horizontal">
					<fieldset class="properties">
						<div class="control-group">
							<label class="control-label">@Messages("author")</label>
							<div class="controls">
								<input type="text" name="authorLoginId" class="input-medium">
							</div>
						</div>
						<div class="control-group">
							<label class="control-label">@Messages("assignee")</label>
							<div class="controls" data-toggle="buttons-radio">
								<button type="button" class="btn" data-assigneeId="0">@Messages("none")</button>
								@for(assignee <- Assignee.finder.where.eq("project.id", project.id).findSet) {
								<button type="button" class="btn" data-assigneeId="@assignee.user.id">
									@**<span class="avatar-wrap small pull-left"><img class="user-picture" src="@urlToPicture(User.find.byId(assignee.user.id).email, 16)"></span>**@
									@User.find.byId(assignee.user.id).name 
								</button>
								}
							</div>
						</div>
						<div class="control-group">
							<label class="control-label">@Messages("milestone")</label>
							<div class="controls" data-toggle="buttons-radio">
								<button type="button" class="btn" data-milestoneId="0">@Messages("none")</button>
								@for(milestone <- Milestone.findByProjectId(project.id)) {
								<button type="button" class="btn" data-milestoneId="@milestone.id">@milestone.title</button>
								}
							</div>
						</div>
					</fieldset>
					<!-- issue.label module make 'labels' fieldset as label filter and editor -->
					<fieldset class="labels"></fieldset>
				</div>
			</div>
		</div>
	</div>

	<div class="filter-wrap board">
		<div class="filters">
			<a href="@urlToList&sortBy=state&orderBy=asc" class="filter"><i class="ico btn-gray-arrow"></i>@Messages("order.state")</a>
			<a href="@urlToList&sortBy=date&orderBy=asc" class="filter"><i class="ico btn-gray-arrow"></i>@Messages("order.date")</a>
			<a href="@urlToList&sortBy=numOfComments&orderBy=asc" class="filter active"><i class="ico btn-gray-arrow down"></i>@Messages("order.comments")</a>
		</div>
	</div>

@if(currentPage.getList().size() > 0){
	<ol class="issue-list">
		@for(issue <- currentPage.getList){
	    <li class="issue">
	        <div class="num"><a href="@routes.IssueApp.issue(project.owner, project.name, issue.id)">@issue.number</a></div>
	        <div class="attach-wrap">
			@if(Attachment.findByContainer(issue.asResource).size > 0){
	        	<i class="ico ico-clip"></i>
	        	}
	        </div>
	        <div class="contents">
	            <p class="title">
	            	<a href="@routes.IssueApp.issue(project.owner, project.name, issue.id)">@issue.title</a>
	            	@** TODO: label 을 <button> 태그를 사용하는게 맞는지 검토 필요 **@
					@for(label <- issue.labels.toList.sortBy(r => (r.category, r.name))) {
                		<button class="issue-label" labelId="@label.id" data-color="@label.color">@label.name</button>
              		}
	            </p>
	            <p class="infos nm">by <a href="@routes.UserApp.userInfo(issue.authorLoginId)" class="author">@Option(issue.authorLoginId).orElse(Option(Messages("issue.noAuthor"))).get</a><!-- 
	             --><span class="date">@agoString(issue.ago)</span></p>
	        </div>
	        <div class="right-panel">
	        	<div class="state @issue.state.toString.toLowerCase">@Messages("issue.state." + issue.state.toString.toLowerCase)</div>
	            <div class="comment-wrap">
	                <i class="ico ico-comment-bubble"></i><span class="num">@issue.comments.size()</span>
	            </div>
	            <a href="@routes.UserApp.userInfo(issue.authorLoginId)" class="avatar-wrap img-rounded pull-right"><!-- 
	             --><img src="@User.findByLoginId(issue.authorLoginId).avatarUrl" width="32" height="32" alt="@issue.authorName"></a>
	        </div>
	    </li>
	    }
	</ol>
} else {
	<div class="error-wrap">
		<i class="ico ico-err1"></i>
		<p>@Messages("issue.is.empty")</p>
	</div>
}

	<div class="write-btn-wrap">
		<a href="@routes.IssueApp.issues(project.owner, project.name, param.state, "xls")" class="n-btn med white btn-save-xls"><i class="ico ico-download"></i>@Messages("issue.downloadAsExcel")</a>
		<a href="@routes.IssueApp.newIssueForm(project.owner, project.name)" class="n-btn med orange">@Messages("issue.menu.new")</a>
	</div>

	<div id="pagination">
		<!-- pagination.js will fill here. -->
	</div>
</div>

<script type="text/javascript">
	$(document).ready(function(){
		var htOptLabel = {
			"bEditable"    : true,
			"sURLLabels"   : "@routes.IssueLabelApp.labels(project.owner, project.name)", 
			"sURLPost"     : "@routes.IssueLabelApp.newLabel(project.owner, project.name)"
		};

		$hive.loadModule("issue.List", {
			"elPagination": $("#pagination"),
			"nTotalPages" : @currentPage.getTotalPageCount,
			"htOptLabel"  : htOptLabel
		});
	});  
</script>
</div>
}